<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>follow typing</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="jquery.cookie.js"></script>
    <style type="text/css">
      .right{background-color:green;}
      .wrong{background-color:red;}
      #ipt{width:1px;position:absolute;height:16px;border:none;}
      #ipt:focus{border-color:red;border:none;}
      body{margin:0 auto;width:960px;}
      #content{overflow:auto;font-size:24px;}
      #content span,#content div{float:left;}
      #content div{clear:both;}
      #name{text-align:center;}
    </style>
    <script type="text/javascript">
      $(document).ready(function(){
        $.getJSON('dizang.json', function(data) {
          var items = [];
          $.each(data, function(name, str) {
            $("#name").html(name);
            $.each(str,function(id,word){
              if(word == "\r") items.push('<div><br></div>');
              else if(word == " " || word == "\n") ;
              else items.push('<span>' + word + '</span>');
            })
            });
          $("#content").html(items.join(""));
          posIpt($.cookie('current') | 0);
        });

        current = $.cookie('current') | 0;
        ipt =$("#ipt")[0]; 

        addEvent(ipt,'textInput',function(e){
          e = e || window.event;
          cha = $("#content span").slice(current,current+e.data.length);
          if(e.data == cha.text()){
            cha.addClass("right");
          }
          else{
            cha.addClass("wrong");
          }
          current += e.data.length;
          posIpt(current);
          $.cookie('current', current,{ expires: 365, path: '/'});
        });

        $("#ipt").keydown(function (event) {
          var keycode = event.which;
          if (keycode == 8){
            current--;
            if(current<0)
              current = 0;
            cha = $("#content span").eq(current);
            cha.removeClass("right wrong");
            posIpt(current);
            $.cookie('current', current,{ expires: 365, path: '/'});
          }
        });
        $("#content").click(function(){
          $('#ipt').focus();
        });
      });

      function addEvent(el,type,fn){
        if(el.addEventListener){
          el.addEventListener(type, fn, false);
        }
        else{
          el.attachEvent('on' + type, fn);
        }       
      }
      function posIpt(current){
        cha = $("#content span").eq(current);
        $('#ipt').css({"top":cha.offset().top,"left":cha.offset().left});
        $('#ipt').focus();
      }
    </script>
  </head>
  <body>
    <h1 id="name"></h1>
    <div id="content"></div>
    <input id="ipt" type="text" />
  </body>
</html>
